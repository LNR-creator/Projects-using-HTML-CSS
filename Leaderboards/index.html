<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeetCode Leaderboard</title>
  <style>
    :root{
      --bg1:#071025; --bg2:#0f2540; --muted:#9aa4b2; --accent:#06b6d4;
      --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#eaf2fb;
      display:flex; align-items:flex-start; justify-content:center; padding:28px;
    }
    .wrap{ width:100%; max-width:980px; }
    header{ display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    h1{ margin:0; font-size:20px; }
    .card{ background: rgba(255,255,255,0.02); padding:18px; border-radius:12px; width:100%; box-shadow:0 10px 30px rgba(3,7,18,0.6); }
    .controls{ display:flex; gap:8px; align-items:center; margin-bottom:14px; flex-wrap:wrap; }
    input[type="text"]{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; min-width:240px; }
    .btn{ background:linear-gradient(90deg,var(--accent), #3b82f6); color:#021024; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn-ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:10px; cursor:pointer; }
    .small{ font-size:13px; color:var(--muted); margin-left:auto; }
    table{ width:100%; border-collapse:collapse; margin-top:6px; font-size:14px; }
    thead th{ text-align:left; font-size:12px; color:var(--muted); padding:12px 10px; text-transform:uppercase; }
    tbody tr{ transition: transform .45s cubic-bezier(.2,.9,.2,1), background-color .35s, opacity .35s; background: linear-gradient(180deg, rgba(255,255,255,0.008), transparent); border-radius:8px; }
    td{ padding:12px 10px; vertical-align:middle; }
    .username-link{ color:var(--accent); text-decoration:none; font-weight:600; }
    .actions { display:flex; gap:8px; justify-content:flex-end; }
    .delete-btn{ background:transparent; border:0; cursor:pointer; padding:6px; border-radius:8px; color:#ff6b6b; font-weight:700; }
    .medal{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; font-weight:700; }
    .gold{ background:linear-gradient(180deg,#ffd700,#f0c000); color:#1a1200; }
    .silver{ background:linear-gradient(180deg,#dcdcdc,#bfbfbf); color:#0b0b0b; }
    .bronze{ background:linear-gradient(180deg,#d08a4c,#b56931); color:#0b0b0b; }
    /* movement classes */
    .rank-up{ animation: rankUpAnim 1s ease; background: rgba(0,255,0,0.08); }
    .rank-down{ animation: rankDownAnim 1s ease; background: rgba(255,0,0,0.06); }
    .fade-in{ animation: fadeIn 0.45s ease; }
    @keyframes fadeIn { from{ opacity:0; transform: translateY(-8px)} to{opacity:1; transform:translateY(0)} }
    @keyframes rankUpAnim { 0%{ transform: translateY(0); } 20%{ transform: translateY(-8px) scale(1.01);} 100%{ transform: translateY(0);} }
    @keyframes rankDownAnim { 0%{ transform: translateY(0);} 20%{ transform: translateY(8px) scale(0.995);} 100%{ transform: translateY(0);} }
    /* top three subtle border */
    tr.top-1 td { box-shadow: inset 0 0 0 2px rgba(255,215,0,0.06); }
    tr.top-2 td { box-shadow: inset 0 0 0 2px rgba(192,192,192,0.06); }
    tr.top-3 td { box-shadow: inset 0 0 0 2px rgba(205,127,50,0.06); }
    @media (max-width:720px){
      thead{ display:none; } table, tbody, tr, td { display:block; width:100%;}
      td{ display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.02);}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üèÜ LeetCode Leaderboard</h1>
        <div class="small">Auto-refresh: <span id="autoStatus">paused</span></div>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="usernameInput" placeholder="Add LeetCode username (e.g. leetcode_user)"/>
        <button id="addBtn" class="btn">Add</button>
        <button id="refreshBtn" class="btn-ghost">Refresh Now</button>
        <button id="toggleAuto" class="btn-ghost">Start Auto</button>
        <div class="small" id="count">Profiles: 0</div>
      </div>

      <table aria-live="polite">
        <thead>
          <tr>
            <th style="width:56px">Rank</th>
            <th>Username</th>
            <th style="width:90px">Total</th>
            <th style="width:80px">Easy</th>
            <th style="width:80px">Medium</th>
            <th style="width:80px">Hard</th>
            <th style="width:100px">Action</th>
          </tr>
        </thead>
        <tbody id="profilesTable">
          <tr><td colspan="7" class="small">No profiles yet ‚Äî add a LeetCode username above.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
/* frontend logic:
 - calls /api/leetcode?username=USERNAME
 - stores list in localStorage "lc_users_v3"
 - auto-updates every second (configurable)
 - animated rank transitions
*/

const PROXY = '/api/leetcode';
const REFRESH_MS = 1000; // per your request: 1 second
let users = JSON.parse(localStorage.getItem('lc_users_v3') || '[]'); // array of usernames
let profiles = []; // array of {username,easy,medium,hard,total}
let prevRanks = {}; // username -> previous rank number
let autoInterval = null;

const usernameInput = document.getElementById('usernameInput');
const addBtn = document.getElementById('addBtn');
const refreshBtn = document.getElementById('refreshBtn');
const toggleAutoBtn = document.getElementById('toggleAuto');
const profilesTable = document.getElementById('profilesTable');
const countEl = document.getElementById('count');
const autoStatus = document.getElementById('autoStatus');

addBtn.addEventListener('click', onAdd);
usernameInput.addEventListener('keydown', e => { if (e.key === 'Enter') onAdd(); });
refreshBtn.addEventListener('click', refreshAll);
toggleAutoBtn.addEventListener('click', toggleAuto);

function saveUsers(){ localStorage.setItem('lc_users_v3', JSON.stringify(users)); countEl.textContent = `Profiles: ${users.length}`; }

function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s=''){ return escapeHtml(s).replace(/"/g,'&quot;'); }

function onAdd(){
  const v = (usernameInput.value || '').trim();
  if (!v) return alert('Enter a username');
  if (users.some(u => u.toLowerCase() === v.toLowerCase())) { usernameInput.value = ''; return alert('User already added'); }
  users.push(v);
  saveUsers();
  usernameInput.value = '';
  // optimistic add with empty stats until fetch resolves
  profiles.push({ username: v, easy: null, medium: null, hard: null, total: null });
  render(); // show immediately
  refreshUser(v);
}

function removeUser(username){
  if(!confirm(`Remove ${username}?`)) return;
  users = users.filter(u => u !== username);
  profiles = profiles.filter(p => p.username !== username);
  saveUsers();
  render();
}

async function fetchFromProxy(username){
  try {
    const r = await fetch(`${PROXY}?username=${encodeURIComponent(username)}`, { cache: 'no-store' });
    if (!r.ok) {
      // server returned 4xx/5xx; try to parse message
      const txt = await r.text().catch(()=>'');
      throw new Error(`HTTP ${r.status} ${txt}`);
    }
    return await r.json();
  } catch (err) {
    console.error('fetch error', username, err);
    return null;
  }
}

async function refreshUser(username){
  const data = await fetchFromProxy(username);
  if (!data) return;
  // expected data: { username, easy, medium, hard, total }
  const idx = profiles.findIndex(p => p.username.toLowerCase() === data.username.toLowerCase());
  const normalized = {
    username: data.username,
    easy: Number(data.easy || 0),
    medium: Number(data.medium || 0),
    hard: Number(data.hard || 0),
    total: Number(data.total || (Number(data.easy||0) + Number(data.medium||0) + Number(data.hard||0)))
  };
  if (idx === -1) profiles.push(normalized); else profiles[idx] = normalized;
  render();
}

async function refreshAll(){
  if (users.length === 0) return;
  // fetch in parallel, but friendly concurrency - limit to avoid server overload
  // For per-second update with few users parallel is OK; if many users, consider increasing delay
  const promises = users.map(u => fetchFromProxy(u));
  const results = await Promise.all(promises);
  profiles = results.filter(Boolean).map(d => ({
    username: d.username,
    easy: Number(d.easy||0),
    medium: Number(d.medium||0),
    hard: Number(d.hard||0),
    total: Number(d.total || (Number(d.easy||0)+Number(d.medium||0)+Number(d.hard||0)))
  }));
  render();
}

/* Render with rank change detection */
function render(){
  // sort by total desc
  profiles.sort((a,b) => (Number(b.total)||0) - (Number(a.total)||0));
  // build table rows
  const tbody = profilesTable;
  tbody.innerHTML = '';
  if (profiles.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" class="small">No profiles yet ‚Äî add a LeetCode username above.</td></tr>`;
    return;
  }

  profiles.forEach((p, idx) => {
    const newRank = idx + 1;
    const oldRank = prevRanks[p.username];

    const tr = document.createElement('tr');
    tr.dataset.username = p.username;

    // top-3 subtle class on row
    if (newRank === 1) tr.classList.add('top-1');
    if (newRank === 2) tr.classList.add('top-2');
    if (newRank === 3) tr.classList.add('top-3');

    // movement classes
    if (!oldRank) tr.classList.add('fade-in');
    else if (oldRank > newRank) tr.classList.add('rank-up');
    else if (oldRank < newRank) tr.classList.add('rank-down');

    prevRanks[p.username] = newRank;

    tr.innerHTML = `
      <td style="width:56px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="medal ${newRank===1?'gold':newRank===2?'silver':newRank===3?'bronze':''}">${newRank<=3?newRank:''}</div>
          <div class="small muted" style="min-width:28px">${newRank}</div>
        </div>
      </td>
      <td><a class="username-link" href="https://leetcode.com/${escapeAttr(p.username)}/" target="_blank" rel="noreferrer">${escapeHtml(p.username)}</a></td>
      <td>${p.total ?? '-'}</td>
      <td>${p.easy ?? '-'}</td>
      <td>${p.medium ?? '-'}</td>
      <td>${p.hard ?? '-'}</td>
      <td class="actions">
        <button class="btn-ghost refresh-one" data-username="${escapeAttr(p.username)}">‚ü≥</button>
        <button class="delete-btn" data-username="${escapeAttr(p.username)}">üóë</button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  // attach handlers
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = e => { const u = e.currentTarget.dataset.username; removeUser(u); };
  });
  document.querySelectorAll('.refresh-one').forEach(btn => {
    btn.onclick = e => { const u = e.currentTarget.dataset.username; refreshUser(u); };
  });

  countEl.textContent = `Profiles: ${users.length}`;
}

/* Auto controls */
function startAuto(){
  if (autoInterval) return;
  autoInterval = setInterval(refreshAll, REFRESH_MS);
  toggleAutoBtn.textContent = 'Stop Auto';
  autoStatus.textContent = `running (${new Date().toLocaleTimeString()})`;
  refreshAll(); // immediate
}
function stopAuto(){
  if (!autoInterval) return;
  clearInterval(autoInterval);
  autoInterval = null;
  toggleAutoBtn.textContent = 'Start Auto';
  autoStatus.textContent = 'paused';
}
function toggleAuto(){ if (autoInterval) stopAuto(); else startAuto(); }

/* Init */
saveUsers();
render();
if (users.length) refreshAll();
// DO NOT automatically start extremely aggressive polling without consent ‚Äî but you asked for 1s updates:
startAuto();

</script>
</body>
</html>
